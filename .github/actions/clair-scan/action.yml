name: clair-scan
description: 'run clair scan against docker image'
inputs:
  github_token:
    description: 'github token'
    required: true

runs:
  using: composite
  steps:
    - name: login to docker
      uses: bruce1237/github_workflow_center/.github/actions/docker-login@main
      with:
       github_token: ${{ inputs.github_token }}

    - name: dash branch name
      uses: bruce1237/github-workflow-center/.github/actions/dash-branch-name@main

    - name: check image before pull
      shell: bash
      run: docker images

    - name: pull image
      shell: bash
      run: docker pull ghcr.io/${{ github.repository }}:${{ env.branch_name }}

    - name: check image after pull
      shell: bash
      run: docker images

    - name: checkout chair-scan
      uses: actions/checkout@v3
      with:
       repository: arminc/clair-scanner
    
    - name: check dir
      shell: bash
      run: ls -lah

    - name: install go
      uses: actions/setup-go@v3
      with:
        go-version: '^1.13.1' # The Go version to download (if necessary) and use.

    - name: build
      shell: bash
      run: make build

    - name: install
      shell: bash
      run: installLocal

    - name: scan
      shell: bash
      run: ./clair-scanner '${{ github.repository }}:${{ env.branch_name }}'

    - name: copy example-run.sh
      shell: bash
      run: |
        cp ./example-run.sh scan.sh
        chmod +x scan.sh
        scan.sh '${{ github.repository }}:${{ env.branch_name }}'